<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AuditPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .badge { @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold; }
      .badge-warn { @apply bg-yellow-100 text-yellow-800; }
      .badge-ok { @apply bg-green-100 text-green-800; }
      .badge-err { @apply bg-red-100 text-red-800; }
      .card { @apply bg-white rounded-xl shadow p-6 space-y-4; }
    </style>
  </head>
  <body class="bg-slate-100 text-slate-900">
    <div class="max-w-5xl mx-auto px-4 py-8 space-y-8">
      <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-2xl font-bold">AuditPulse minimal</h1>
          <p class="text-sm text-slate-500">HubSpot data quality audits powered by Supabase worker leases.</p>
        </div>
        <a id="installLink" href="/api/install" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold">Install on HubSpot</a>
      </header>

      <section class="card">
        <div class="grid gap-4 md:grid-cols-4 md:items-end">
          <label class="space-y-2">
            <span class="text-sm font-medium text-slate-600">Portal ID</span>
            <input id="portalInput" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="123456" />
          </label>
          <div class="space-y-2">
            <span class="text-sm font-medium text-slate-600">Install status</span>
            <div id="statusBadge" class="badge badge-warn">Unknown</div>
          </div>
          <div class="space-y-2">
            <span class="text-sm font-medium text-slate-600">Actions</span>
            <div class="flex gap-2">
              <button id="checkBtn" class="px-4 py-2 rounded-lg border border-slate-300 text-sm font-semibold">Check</button>
            </div>
          </div>
          <div class="space-y-2">
            <span class="text-sm font-medium text-slate-600">Run audit</span>
            <div class="flex flex-wrap gap-2">
              <button data-type="contacts" class="run-btn px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold disabled:opacity-40">Contacts</button>
              <button data-type="companies" class="run-btn px-4 py-2 rounded-lg bg-slate-200 text-sm font-semibold disabled:opacity-40">Companies</button>
              <button data-type="workflows" class="run-btn px-4 py-2 rounded-lg bg-slate-200 text-sm font-semibold disabled:opacity-40">Workflows</button>
            </div>
          </div>
        </div>
      </section>

      <section id="jobSection" class="card hidden">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <div class="text-sm text-slate-500">Job</div>
            <div id="jobMeta" class="text-sm font-semibold"></div>
          </div>
          <button id="downloadBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hidden">Download Excel</button>
        </div>
        <div class="space-y-2">
          <div class="flex items-center gap-2">
            <div id="jobStatusBadge" class="badge badge-warn">pending</div>
            <span id="jobMessage" class="text-sm text-slate-600">Waiting…</span>
          </div>
          <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
            <div id="jobProgressBar" class="bg-indigo-600 h-2" style="width: 0%"></div>
          </div>
          <div id="jobCounts" class="text-xs text-slate-500">0 / 0</div>
        </div>
        <div id="jobError" class="hidden rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700"></div>
      </section>

      <section id="resultSection" class="card hidden">
        <h2 class="text-lg font-semibold">Results</h2>
        <div id="summaryGrid" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3"></div>
        <div class="space-y-3">
          <h3 class="font-semibold">Orphan sample</h3>
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr>
                <th class="py-2 pr-3">Record ID</th>
                <th class="py-2">Label</th>
              </tr>
            </thead>
            <tbody id="orphanTable" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
        <div class="space-y-3">
          <h3 class="font-semibold">Duplicate keys</h3>
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr>
                <th class="py-2 pr-3">Type</th>
                <th class="py-2 pr-3">Key</th>
                <th class="py-2 pr-3">Count</th>
                <th class="py-2">Sample IDs</th>
              </tr>
            </thead>
            <tbody id="duplicateTable" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
        <div class="space-y-3">
          <h3 class="font-semibold">Sparsest properties</h3>
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr>
                <th class="py-2 pr-3">Property</th>
                <th class="py-2 pr-3">Filled</th>
                <th class="py-2">Fill rate</th>
              </tr>
            </thead>
            <tbody id="propertyTable" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
        <div id="riskSection" class="space-y-3 hidden">
          <h3 class="font-semibold">Workflow risks</h3>
          <div class="grid gap-4 lg:grid-cols-2">
            <div>
              <h4 class="text-sm font-semibold text-slate-600">Exposed API keys</h4>
              <ul id="riskApiList" class="space-y-1 text-sm text-slate-600"></ul>
            </div>
            <div>
              <h4 class="text-sm font-semibold text-slate-600">Legacy email API actions</h4>
              <ul id="riskLegacyList" class="space-y-1 text-sm text-slate-600"></ul>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const qs = new URLSearchParams(location.search);
      const portalInput = document.getElementById('portalInput');
      const statusBadge = document.getElementById('statusBadge');
      const checkBtn = document.getElementById('checkBtn');
      const runButtons = Array.from(document.querySelectorAll('.run-btn'));
      const jobSection = document.getElementById('jobSection');
      const jobMeta = document.getElementById('jobMeta');
      const jobStatusBadge = document.getElementById('jobStatusBadge');
      const jobMessage = document.getElementById('jobMessage');
      const jobProgressBar = document.getElementById('jobProgressBar');
      const jobCounts = document.getElementById('jobCounts');
      const jobError = document.getElementById('jobError');
      const downloadBtn = document.getElementById('downloadBtn');
      const resultSection = document.getElementById('resultSection');
      const summaryGrid = document.getElementById('summaryGrid');
      const orphanTable = document.getElementById('orphanTable');
      const duplicateTable = document.getElementById('duplicateTable');
      const propertyTable = document.getElementById('propertyTable');
      const riskSection = document.getElementById('riskSection');
      const riskApiList = document.getElementById('riskApiList');
      const riskLegacyList = document.getElementById('riskLegacyList');

      const initialPortal = qs.get('portal_id');
      if (initialPortal) portalInput.value = initialPortal;
      if (qs.get('installed') === '1' && initialPortal) {
        setBadge(statusBadge, 'ok', 'Installed');
        enableRunButtons(true);
      }

      let activeJobId = null;
      let pollDelay = 2000;
      let pollTimer = null;

      function setBadge(el, state, text) {
        el.className = `badge ${state === 'ok' ? 'badge-ok' : state === 'err' ? 'badge-err' : 'badge-warn'}`;
        el.textContent = text;
      }

      function enableRunButtons(enabled) {
        runButtons.forEach(btn => (btn.disabled = !enabled));
      }

      async function checkInstall() {
        const portalId = portalInput.value.trim();
        if (!portalId) return;
        setBadge(statusBadge, 'warn', 'Checking…');
        enableRunButtons(false);
        try {
          const res = await fetch(`/api/install-status?portal_id=${encodeURIComponent(portalId)}`);
          if (!res.ok) throw new Error('Request failed');
          const data = await res.json();
          if (data.installed) {
            setBadge(statusBadge, 'ok', 'Installed');
            enableRunButtons(true);
          } else {
            setBadge(statusBadge, 'warn', 'Not installed');
          }
        } catch (err) {
          setBadge(statusBadge, 'err', 'Error');
          console.error(err);
        }
      }

      async function startJob(objectType) {
        const portalId = portalInput.value.trim();
        if (!portalId) return;
        enableRunButtons(false);
        setBadge(statusBadge, 'warn', 'Checking…');
        await checkInstall();
        if (statusBadge.classList.contains('badge-ok') === false) {
          enableRunButtons(true);
          return;
        }

        try {
          const res = await fetch('/api/create-job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portalId, objectType })
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({ error: 'Failed to create job' }));
            throw new Error(err.error || 'Failed to create job');
          }
          const data = await res.json();
          activeJobId = data.jobId;
          pollDelay = 2000;
          jobSection.classList.remove('hidden');
          jobMeta.textContent = `${objectType} • ${portalId}`;
          setBadge(jobStatusBadge, 'warn', 'pending');
          jobMessage.textContent = 'Queued…';
          jobProgressBar.style.width = '0%';
          jobCounts.textContent = '0 / 0';
          jobError.classList.add('hidden');
          resultSection.classList.add('hidden');
          downloadBtn.classList.add('hidden');
          downloadBtn.onclick = () => {};
          schedulePoll();
        } catch (err) {
          enableRunButtons(true);
          setBadge(jobStatusBadge, 'err', 'error');
          jobError.classList.remove('hidden');
          jobError.textContent = err.message;
        }
      }

      async function pollJobStatus() {
        if (!activeJobId) return;
        try {
          const res = await fetch(`/api/job-status?job_id=${encodeURIComponent(activeJobId)}`);
          if (!res.ok) throw new Error('Status request failed');
          const job = await res.json();
          updateJobUi(job);
          if (job.status === 'complete' || job.status === 'failed') {
            activeJobId = null;
            return;
          }
        } catch (err) {
          console.error(err);
        }
        schedulePoll();
      }

      function schedulePoll() {
        clearTimeout(pollTimer);
        pollTimer = setTimeout(() => {
          pollDelay = Math.min(pollDelay + 1000, 10000);
          pollJobStatus();
        }, pollDelay);
      }

      function updateJobUi(job) {
        setBadge(jobStatusBadge, job.status === 'complete' ? 'ok' : job.status === 'failed' ? 'err' : 'warn', job.status);
        jobMessage.textContent = job.progressMessage || '';
        const processed = Number(job.processedRecords || 0);
        const total = Number(job.totalRecords || 0);
        const percent = total > 0 ? Math.min(100, Math.round((processed / total) * 100)) : job.status === 'complete' ? 100 : 0;
        jobProgressBar.style.width = `${percent}%`;
        jobCounts.textContent = `${processed.toLocaleString()} / ${total ? total.toLocaleString() : '—'}`;

        if (job.error) {
          jobError.classList.remove('hidden');
          jobError.textContent = job.error;
        } else {
          jobError.classList.add('hidden');
        }

        if (job.status === 'complete') {
          enableRunButtons(true);
          renderResults(job.resultJson || job.results || {});
          downloadBtn.classList.remove('hidden');
          downloadBtn.onclick = () => {
            window.location.href = `/api/download?job_id=${encodeURIComponent(job.jobId)}`;
          };
        } else if (job.status === 'failed') {
          enableRunButtons(true);
        }
      }

      function renderResults(result) {
        resultSection.classList.remove('hidden');
        summaryGrid.innerHTML = '';
        const summary = Array.isArray(result.summary) ? result.summary : [];
        summary.forEach(item => {
          const card = document.createElement('div');
          card.className = 'rounded-lg border border-slate-200 p-3';
          card.innerHTML = `<div class="text-xs text-slate-500">${item.label || item.metric}</div><div class="text-xl font-semibold">${item.value}</div>`;
          summaryGrid.appendChild(card);
        });

        orphanTable.innerHTML = '';
        const orphanSample = Array.isArray(result.orphanSamples) ? result.orphanSamples : [];
        orphanSample.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2 pr-3">${row.id || ''}</td><td class="py-2">${row.label || row.email || ''}</td>`;
          orphanTable.appendChild(tr);
        });

        duplicateTable.innerHTML = '';
        const duplicates = Array.isArray(result.duplicateKeys) ? result.duplicateKeys : [];
        duplicates.forEach(row => {
          const tr = document.createElement('tr');
          const samples = Array.isArray(row.samples) ? row.samples.join(', ') : '';
          tr.innerHTML = `<td class="py-2 pr-3">${row.type}</td><td class="py-2 pr-3">${row.key}</td><td class="py-2 pr-3">${row.count}</td><td class="py-2">${samples}</td>`;
          duplicateTable.appendChild(tr);
        });

        propertyTable.innerHTML = '';
        const properties = Array.isArray(result.propertyFill) ? result.propertyFill : [];
        properties.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2 pr-3">${row.property}</td><td class="py-2 pr-3">${row.filled}</td><td class="py-2">${row.fillRate}</td>`;
          propertyTable.appendChild(tr);
        });

        riskSection.classList.add('hidden');
        riskApiList.innerHTML = '';
        riskLegacyList.innerHTML = '';
        const risks = result && result.risks ? result.risks : {};
        const apiRisks = Array.isArray(risks.exposedApiKeys) ? risks.exposedApiKeys : [];
        const legacyRisks = Array.isArray(risks.legacyEmailApi) ? risks.legacyEmailApi : [];

        if (apiRisks.length || legacyRisks.length) {
          riskSection.classList.remove('hidden');
          if (apiRisks.length) {
            apiRisks.forEach(item => {
              const li = document.createElement('li');
              li.textContent = `${item.name || 'Unnamed workflow'} (ID ${item.id})`;
              riskApiList.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.className = 'text-slate-400';
            li.textContent = 'None detected';
            riskApiList.appendChild(li);
          }

          if (legacyRisks.length) {
            legacyRisks.forEach(item => {
              const li = document.createElement('li');
              li.textContent = `${item.name || 'Unnamed workflow'} (ID ${item.id})`;
              riskLegacyList.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.className = 'text-slate-400';
            li.textContent = 'None detected';
            riskLegacyList.appendChild(li);
          }
        }
      }

      checkBtn.addEventListener('click', checkInstall);
      runButtons.forEach(btn => btn.addEventListener('click', () => startJob(btn.dataset.type)));

      if (initialPortal) {
        checkInstall();
      }
    </script>
  </body>
</html>
