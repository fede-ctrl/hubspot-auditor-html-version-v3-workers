<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AuditPulse Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind via CDN (allowed by server Helmet CSP) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .card { @apply bg-white rounded-2xl shadow p-5; }
    .btn  { @apply px-4 py-2 rounded-xl text-sm font-semibold transition; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-ghost   { @apply bg-gray-100 text-gray-900 hover:bg-gray-200; }
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded text-xs font-medium; }
    .badge-ok { @apply bg-green-100 text-green-800; }
    .badge-warn { @apply bg-yellow-100 text-yellow-800; }
    .badge-err { @apply bg-red-100 text-red-800; }
    .muted { @apply text-gray-500; }
    .kbd { @apply border rounded px-1 mono text-xs; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto px-4 py-8 space-y-8">

    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-indigo-600 flex items-center justify-center text-white font-bold">A</div>
        <h1 class="text-2xl font-bold">AuditPulse Pro</h1>
      </div>
      <a id="installLink" href="/api/install" class="btn btn-ghost">Install on HubSpot</a>
    </header>

    <!-- Install / Portal -->
    <section class="card space-y-4">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="space-y-1">
          <div class="text-sm text-gray-600">Portal ID</div>
          <input id="portalId" class="w-64 border rounded-xl px-3 py-2" placeholder="e.g. 1234567" />
          <p class="text-xs text-gray-500">Auto-filled after OAuth. You can override it.</p>
        </div>

        <div class="space-y-1">
          <div class="text-sm text-gray-600">Status</div>
          <div id="installStatus" class="badge badge-warn">Not installed</div>
        </div>

        <div class="space-y-1">
          <div class="text-sm text-gray-600">Actions</div>
          <div class="flex gap-2">
            <button id="btnContacts" class="btn btn-primary">Run Contacts Audit</button>
            <button id="btnCompanies" class="btn btn-ghost">Run Companies Audit</button>
            <button id="btnWorkflows" class="btn btn-ghost">Run Workflows Audit</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Job Panel -->
    <section id="jobPanel" class="card space-y-4 hidden">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-600">Job</div>
          <div class="mono text-sm" id="jobMeta">—</div>
        </div>
        <div>
          <button id="btnDownload" class="btn btn-primary hidden">Download Excel</button>
        </div>
      </div>

      <div id="progressWrap" class="space-y-2">
        <div class="flex items-center gap-2">
          <div id="statusBadge" class="badge badge-warn">pending</div>
          <div id="progressMsg" class="text-sm">Queued…</div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 2%"></div>
        </div>
        <div id="progressNums" class="text-xs text-gray-500">0 / ?</div>
      </div>

      <div id="errorBox" class="hidden rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-800"></div>
    </section>

    <!-- Results -->
    <section id="resultsPanel" class="card space-y-6 hidden">
      <h2 class="text-lg font-semibold">Results</h2>

      <div id="summary" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>

      <div class="space-y-3">
        <h3 class="font-semibold">Orphaned sample</h3>
        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500">
                <th class="py-2 pr-3">Record ID</th>
                <th class="py-2">Email/Domain</th>
              </tr>
            </thead>
            <tbody id="orphanTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="space-y-3">
        <h3 class="font-semibold">Top duplicate keys</h3>
        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500">
                <th class="py-2 pr-3">Type</th>
                <th class="py-2 pr-3">Key</th>
                <th class="py-2 pr-3">Count</th>
                <th class="py-2">Sample IDs</th>
              </tr>
            </thead>
            <tbody id="dupTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="space-y-3">
        <h3 class="font-semibold">Sparsest properties (top 20)</h3>
        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500">
                <th class="py-2 pr-3">Property</th>
                <th class="py-2 pr-3">Filled</th>
                <th class="py-2">Fill rate</th>
              </tr>
            </thead>
            <tbody id="propsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="text-center text-xs text-gray-500">
      Built for long-running audits. Uses background workers, streaming CSV, and Excel export.
    </footer>
  </div>

  <script>
    // ---------- Small helpers ----------
    const $ = sel => document.querySelector(sel);
    const qs = new URLSearchParams(location.search);
    function fmtPct(n) { return (Math.round((n || 0) * 10000) / 100).toFixed(2) + '%'; }
    function setBadge(el, kind, text) {
      el.className = 'badge ' + (kind === 'ok' ? 'badge-ok' : kind === 'err' ? 'badge-err' : 'badge-warn');
      el.textContent = text;
    }

    // ---------- Init from URL ----------
    const installed = qs.get('installed') === '1';
    const portalFromUrl = qs.get('portal_id');
    if (portalFromUrl) $('#portalId').value = portalFromUrl;

    // Status badge for install
    setBadge($('#installStatus'), installed ? 'ok' : 'warn', installed ? 'Installed' : 'Not installed');

    // ---------- API calls ----------
    async function createJob(portal_id, object_type) {
      const res = await fetch('/api/create-audit-job', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ portal_id, object_type })
      });
      if (!res.ok) {
        const t = await res.text().catch(()=>'');
        throw new Error('Create job failed: ' + t);
      }
      return res.json();
    }

    async function fetchStatus(jobId) {
      const res = await fetch('/api/audit-status/' + encodeURIComponent(jobId));
      if (!res.ok) {
        const t = await res.text().catch(()=>'');
        throw new Error('Status failed: ' + t);
      }
      return res.json();
    }

    // ---------- UI state ----------
    let currentJobId = null;
    let currentType = null;

    function showJobPanel(job) {
      $('#jobPanel').classList.remove('hidden');
      $('#errorBox').classList.add('hidden');
      $('#resultsPanel').classList.add('hidden');
      $('#btnDownload').classList.add('hidden');
      $('#jobMeta').textContent = `${job.job_id} • ${job.object_type}`;
      setBadge($('#statusBadge'), 'warn', job.status || 'pending');
      $('#progressMsg').textContent = job.progress_message || 'Queued…';
      $('#progressBar').style.width = '2%';
      $('#progressNums').textContent = '0 / ?';
    }

    function updateProgressUI(job) {
      const status = job.status || 'pending';
      const msg = job.progress_message || '';
      const processed = Number(job.processed_records || 0);
      const total = Number(job.total_records || 0);
      let pct = 0;
      if (total > 0) pct = Math.max(0, Math.min(100, Math.round((processed / total) * 100)));

      setBadge($('#statusBadge'),
        status === 'complete' ? 'ok' : status === 'failed' ? 'err' : 'warn',
        status
      );
      $('#progressMsg').textContent = msg;
      $('#progressBar').style.width = (pct || 2) + '%';
      $('#progressNums').textContent = `${processed.toLocaleString()} / ${total ? total.toLocaleString() : '?'}`;
    }

    function showError(errText) {
      const box = $('#errorBox');
      box.textContent = errText;
      box.classList.remove('hidden');
    }

    // ---------- Exponential backoff poller ----------
    async function pollUntilDone(jobId, onUpdate) {
      let delay = 1500;          // start fast
      const maxDelay = 10000;    // cap to 10s

      while (true) {
        try {
          const job = await fetchStatus(jobId);
          onUpdate(job);

          if (job.status === 'complete') return job;
          if (job.status === 'failed') throw new Error(job.error || 'Job failed.');

        } catch (e) {
          showError(e.message || String(e));
        }

        await new Promise(r => setTimeout(r, delay));
        delay = Math.min(maxDelay, Math.round(delay * 1.5));
      }
    }

    // ---------- Results rendering ----------
    function renderResults(job) {
      const results = job.results || job.result_json || {};
      $('#resultsPanel').classList.remove('hidden');

      // Summary cards
      const counts = results.counts || {};
      const totals = results.totals || {};
      const meta = results.meta || {};
      const rows = [
        ['Object Type', results.objectType || job.object_type],
        ['Total Records', (totals.totalRecords || 0).toLocaleString()],
        ['Ownerless', counts.ownerless ?? ''],
        ['Lifecycle Missing', counts.lifecycleMissing ?? ''],
        ['Invalid Emails (contacts)', counts.invalidEmails ?? ''],
        ['Stale Records (>=180d)', counts.staleRecords ?? ''],
        ['Processed Cap', meta.processedCap ?? '']
      ];
      $('#summary').innerHTML = rows.map(([k, v]) => `
        <div class="border rounded-xl p-4">
          <div class="text-xs text-gray-500">${k}</div>
          <div class="text-base font-semibold">${v}</div>
        </div>
      `).join('');

      // Orphaned sample
      const orphan = (results.orphaned && results.orphaned.sample) || [];
      $('#orphanTbody').innerHTML = orphan.map(o => `
        <tr class="border-t">
          <td class="py-2 pr-3 mono">${o.id || ''}</td>
          <td class="py-2">${o.email || o.domain || ''}</td>
        </tr>
      `).join('') || `<tr><td class="py-2 text-gray-500" colspan="2">No sample available.</td></tr>`;

      // Duplicates combined
      const dup = results.duplicates || {};
      const samples = dup.samples || {};
      const blocks = [];
      for (const typ of ['byEmail', 'byDomain', 'byPhone']) {
        for (const item of (samples[typ] || [])) {
          const ids = (item.sample || []).map(s => s.id).filter(Boolean).join(', ');
          blocks.push(`
            <tr class="border-t">
              <td class="py-2 pr-3">${typ}</td>
              <td class="py-2 pr-3 mono">${item.value}</td>
              <td class="py-2 pr-3">${item.count}</td>
              <td class="py-2 mono">${ids}</td>
            </tr>
          `);
        }
      }
      $('#dupTbody').innerHTML = blocks.join('') || `<tr><td class="py-2 text-gray-500" colspan="4">No duplicates detected in sample.</td></tr>`;

      // Sparsest properties top 20
      const props = (results.properties && results.properties.top20Sparsest) || [];
      $('#propsTbody').innerHTML = props.map(p => `
        <tr class="border-t">
          <td class="py-2 pr-3 mono">${p.property}</td>
          <td class="py-2 pr-3">${(p.filled || 0).toLocaleString()}</td>
          <td class="py-2">${fmtPct(p.fillRate || 0)}</td>
        </tr>
      `).join('') || `<tr><td class="py-2 text-gray-500" colspan="3">N/A</td></tr>`;
    }

    // ---------- Handlers ----------
    async function startAudit(kind) {
      const portal_id = $('#portalId').value.trim();
      if (!portal_id) {
        alert('Please enter a Portal ID.');
        return;
      }
      currentType = kind;

      // Create job
      const { job_id } = await createJob(portal_id, kind);
      currentJobId = job_id;

      // Show panel and begin polling
      showJobPanel({ job_id, object_type: kind, status: 'pending', progress_message: 'Queued…' });

      const finalJob = await pollUntilDone(job_id, (job) => {
        updateProgressUI(job);
      });

      // Enable download and render results
      $('#btnDownload').classList.remove('hidden');
      $('#btnDownload').onclick = () => {
        location.href = '/api/download-excel?jobId=' + encodeURIComponent(job_id);
      };

      renderResults(finalJob);
    }

    $('#btnContacts').addEventListener('click', () => startAudit('contacts'));
    $('#btnCompanies').addEventListener('click', () => startAudit('companies'));
    $('#btnWorkflows').addEventListener('click', () => startAudit('workflows'));
  </script>
</body>
</html>
